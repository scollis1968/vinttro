cat vhosts.conf
# This block handles all HTTP traffic and redirects to HTTPS.
server {
    listen 80;
    listen [::]:80;
    server_name wordpress.uat.vinttro.co.uk suitecrm.uat.vinttro.co.uk;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name services.uat.vinttro.co.uk;

    # Certbot SSL configuration
    ssl_certificate /etc/letsencrypt/live/services.uat.vinttro.co.uk/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/services.uat.vinttro.co.uk/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # This is the crucial part that handles the webhook
    location /hooks/deploy-vinttro {
        # The proxy_pass directive forwards the request to the local webhook service.
        # Replace the port (e.g., 8080) and URL with your local service's address.
        proxy_pass http://localhost:9000;
        
        # These headers ensure the original request information is passed on.
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Optional: You can add IP whitelisting for security here.
        # This will only allow GitHub's IP addresses to connect.
        # You'll need to find the current list of GitHub's webhook IPs and update this.
        # allow 140.82.112.0/20;
        # deny all;
    }

    # Add other locations as needed, or a default 404
    location / {
        return 404;
    }
}


# This block handles the WordPress HTTPS site.
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name wordpress.uat.vinttro.co.uk;
    root /var/www/wordpress;
    index index.php index.html index.htm;

    # SSL certificates are managed by Certbot
    ssl_certificate /etc/letsencrypt/live/wordpress.uat.vinttro.co.uk/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/wordpress.uat.vinttro.co.uk/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    location ~ \.php$ {
        fastcgi_pass unix:/run/php/php8.2-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }
}


server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name suitecrm.uat.vinttro.co.uk;
    root /var/www/suitecrm/public;
    index index.php index.html index.htm;

    # SSL certificates are managed by Certbot
    ssl_certificate /etc/letsencrypt/live/suitecrm.uat.vinttro.co.uk/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/suitecrm.uat.vinttro.co.uk/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # Rewrite rules from the .htaccess file. These are crucial for the legacy API.
    location ~ ^/legacy/Api/(access_token|V8)/ {
        rewrite ^/legacy/Api/(.*)$ /legacy/Api/index.php last;
    }

    location /legacy {
        rewrite ^/legacy(.*)$ /legacy/index.php?$1;
    }

    # Location block for all other PHP files.
    location ~ \.php$ {
        try_files $uri =404;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }
    
    # The main location block for all requests
    location / {
        try_files $uri $uri/ /index.php$is_args$args;
    }

    # Deny direct access to all hidden files and directories
    location ~ /\. {
        deny all;
    }
}